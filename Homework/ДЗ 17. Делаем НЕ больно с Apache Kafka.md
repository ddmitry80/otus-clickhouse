# ДЗ 17. Делаем НЕ больно с Apache Kafka

Материалы:
- https://github.com/conduktor/kafka-stack-docker-compose
- https://github.com/AlexeyFerum/teaching_time/wiki/Sbornaya-solyanka#clickhouse--kafka-on-yc


## Одиночный сервер
```sql
CREATE DATABASE kafka ON CLUSTER c2sh2rep;

DROP TABLE IF EXISTS kafka.SampleJson_ext NO DELAY; -- on cluster c2sh2rep NO DELAY;

SET allow_experimental_json_type = 1;
DROP TABLE IF EXISTS kafka.SampleJson_ext NO DELAY;
CREATE TABLE kafka.SampleJson_ext -- on cluster c2sh2rep
(
    --id UInt64
    json JSON
    --, msg String
--    , _topic LowCardinality(String)
--    , _key String  -- Ключ сообщения
--    , _offset UInt64  -- Смещение сообщения
--    , _partition UInt64  -- Партиция темы Kafka
--    , _timestamp Nullable(DateTime) -- Метка времени сообщения

) ENGINE = Kafka()
SETTINGS
    kafka_broker_list = 'PLAINTEXT://kafka:29092'
    , kafka_topic_list = 'SampleJson2Kafka'
    , kafka_group_name = 'nifi.dev.SampleJson2Kafka.3'
    , kafka_handle_error_mode='stream'
    , kafka_format = 'JSONAsObject'
;

set stream_like_engine_allow_direct_select = 1;
select "json", _topic, _key, _offset, _partition, _timestamp, _raw_message from kafka.SampleJson_ext;

SET allow_experimental_json_type = 1;
DROP TABLE IF EXISTS stg.SampleJson NO DELAY;
CREATE TABLE stg.SampleJson
(
    --id UInt64
    json String
    , _topic LowCardinality(String)
    , _key String  -- Ключ сообщения
    , _offset UInt64  -- Смещение сообщения
    , _partition UInt64  -- Партиция темы Kafka
    , _timestamp Nullable(DateTime) -- Метка времени сообщения
    , created_at DateTime DEFAULT now()
)
ENGINE = MergeTree() ORDER BY (created_at);

DROP VIEW IF EXISTS stg.SampleJson_mv;
CREATE MATERIALIZED VIEW stg.SampleJson_mv TO stg.SampleJson
AS SELECT
    --id
    json
    , _topic
    , _key  -- Ключ сообщения
    , _offset  -- Смещение сообщения
    , _partition  -- Партиция темы Kafka
    , _timestamp  -- Метка времени сообщения
FROM kafka.SampleJson_ext;
attach TABLE  kafka.SampleJson_ext;

select * from stg.SampleJson;
```
## Кластер

```sql
---------- cluster mode 
DROP TABLE IF EXISTS kafka.SampleJson_cl_ext ON CLUSTER c2sh2rep NO DELAY;
CREATE TABLE kafka.SampleJson_cl_ext ON CLUSTER c2sh2rep
(
    id UInt64
) ENGINE = Kafka()
SETTINGS
    kafka_broker_list = 'PLAINTEXT://kafka:29092'
    , kafka_topic_list = 'SampleJson2Kafka'
    , kafka_group_name = 'nifi.dev.SampleJson2Kafka_cl.1'
    , kafka_handle_error_mode='stream'
    , kafka_format = 'Raw'
;

set stream_like_engine_allow_direct_select = 1;
select id, _raw_message, _topic, _key, _offset, _partition, _timestamp from kafka.SampleJson_cl_ext;

DROP TABLE IF EXISTS stg.SampleJson_rep NO DELAY;
CREATE TABLE stg.SampleJson_rep ON CLUSTER c2sh2rep
(
    id UInt64
    , json String
    , _topic LowCardinality(String)
    , _key String  -- Ключ сообщения
    , _offset UInt64  -- Смещение сообщения
    , _partition UInt64  -- Партиция темы Kafka
    , _timestamp Nullable(DateTime) -- Метка времени сообщения
    , created_at DateTime DEFAULT now()
)
ENGINE = ReplicatedMergeTree('/clickhouse/shard_{shard_c2sh2rep}/{database}/{table}','{replica_c2sh2rep}')
PARTITION BY toYYYYMMDD(created_at)
ORDER BY created_at;

-- Распределенная таблица поверх реплицированной
DROP TABLE IF EXISTS stg.SampleJson_sh ON CLUSTER c2sh2rep;
CREATE TABLE stg.SampleJson_sh ON CLUSTER c2sh2rep
AS stg.SampleJson_rep
ENGINE = Distributed(c2sh2rep, stg, SampleJson_rep, rand());

select * from stg.SampleJson_sh;

CREATE MATERIALIZED VIEW stg.SampleJson_cl_mv ON CLUSTER c2sh2rep TO stg.SampleJson_rep 
AS SELECT
    id
    , _raw_message as json
    , _topic  -- Имя топика
    , _key  -- Ключ сообщения
    , _offset  -- Смещение сообщения
    , _partition  -- Партиция темы Kafka
    , _timestamp  -- Метка времени сообщения
FROM kafka.SampleJson_cl_ext;

select hostName() AS hostname, shardNum() AS shard_number, t.* from stg.SampleJson_sh t order by created_at desc;

select * from stg.SampleJson_sh t order by created_at desc;

select count(*) from stg.SampleJson_sh;
```
